ext {
  builderMaxHeapSize = '4g'
  siteUri = 'http://docs-stg.mulesoft.com'
  stagingUser = 'ec2-user'
  stagingIdentity = project.hasProperty('stagingIdentity') ? project.property('stagingIdentity') : new File(System.getProperty('user.home'), '.ssh/id_rsa').toString()
  stagingHost = 'docs-stg.mulesoft.com'
  stagingDestinationDir = '/usr/share/nginx/html'
  //stagingUser = System.getProperty('user.name')
  //stagingHost = 'localhost'
  //stagingDestinationDir = '/tmp/html'
}

task publishToStaging(type: Exec, group: 'Publishing', description: 'Synchronizes site output to remote staging server') {
  mustRunAfter 'build'
  executable 'rsync'
  // transfer status legend: http://stackoverflow.com/questions/4493525/rsync-what-means-the-f-on-rsync-logs/12037164#12037164
  // QUESTION should we use --size-only to ignore timestamp changes?
  args '-a', '-z', '-i', "-e ssh -i $stagingIdentity", '--delete-delay', "$siteDir/", "$stagingUser@$stagingHost:$stagingDestinationDir/"
  if (dryRun) args = ['-n'] + args
}

task publish(group: 'Build', description: 'Builds site and copies changes to staging server') {
  dependsOn 'build', publishToStaging
}
